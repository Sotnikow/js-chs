<!doctype html>
<html lang="ru">
<head>
	<meta charset="UTF-8">
	<title>Chess</title>
	<link rel="stylesheet" type="text/css" href="http://yui.yahooapis.com/3.15.0/build/cssreset/cssreset-min.css">
	<style>
		img { padding:0; margin:auto;display:block; }
		div {padding:0;margin:0;}
		div.string { height:50px; }
		div.square { text-align:center; }
	</style>
	<script src="js/jquery-1.11.0.min.js"></script>
	<script src="js/chess.js"></script>
	<script>
		ch = Chess({ append: '#chess1' });
		// Добавление типов
		ch.type.add('Пешка');
		ch.type.add('Слон');
		ch.type.add('Ферзь');
		ch.type.add('Король');
		ch.type.add('Ладья');
		ch.type.add('Конь');
		
		// Раставляем пешки
		for (var i = 1; i < 9; i++) {
			ch.element.add('Пешка', [2, i]);
			ch.element.add('Пешка', [7, i]);
		}
		
		// Добавляем ладьи
		ch.element.add('Ладья',[8,1]);
		ch.element.add('Ладья',[8,8]);
		ch.element.add('Ладья',[1,1]);
		ch.element.add('Ладья',[1,8]);
		
		// Добавляем коней
		ch.element.add('Конь',[8,2]);
		ch.element.add('Конь',[8,7]);
		ch.element.add('Конь',[1,2]);
		ch.element.add('Конь',[1,7]);
		
		// Добавляем слонов
		ch.element.add('Слон',[8,3]);
		ch.element.add('Слон',[8,6]);
		ch.element.add('Слон',[1,6]);
		ch.element.add('Слон',[1,3]);
		
		// Добавляем королей
		ch.element.add('Король',[8,5]);
		ch.element.add('Король',[1,5]);
		
		// Добавляем королей
		ch.element.add('Ферзь',[8,4]);
		ch.element.add('Ферзь',[1,4]);
		
		// ПРАВИЛА
		// - помеха на пути
		ch.right.add('На пути помеха', function (el, new_pos) {
			// по диагонали
			if (el.position[0] != new_pos[0] && el.position[1] != new_pos[1] && Math.abs(el.position[0] - new_pos[0]) == Math.abs(el.position[1] - new_pos[1])) {
				var steps = Math.abs(el.position[0] - new_pos[0]);
				var factor0 = (new_pos[0] - el.position[0])/steps;
				var factor1 = (new_pos[1] - el.position[1])/steps;
				for (var i = 1; i < steps; i++) {
					if (ch.fn.findSubstrInSubstr(ch.element.all, 'position', [el.position[0] + (i * factor0), el.position[1]  + (i * factor1)]) != -1) return false;
				}
			}
			// по вертикали
			if (el.position[0] != new_pos[0] && el.position[1] == new_pos[1]) {
				var steps = Math.abs(el.position[0] - new_pos[0]);
				var factor0 = (new_pos[0] - el.position[0])/steps;
				for (var i = 1; i < steps; i++) {
					if (ch.fn.findSubstrInSubstr(ch.element.all, 'position', [el.position[0] + (i * factor0), el.position[1]]) != -1) return false;
				}
			}
			// по горизонтали
			if (el.position[0] == new_pos[0] && el.position[1] != new_pos[1]) {
				var steps = Math.abs(el.position[1] - new_pos[1]);
				var factor1 = (new_pos[1] - el.position[1])/steps;
				for (var i = 1; i < steps; i++) {
					if (ch.fn.findSubstrInSubstr(ch.element.all, 'position', [el.position[0], el.position[1]  + (i * factor1)]) != -1) return false;
				}
			}
		});
		
		// - шаг для пешки
		ch.right.add('Шаг', function (el, new_pos) {
			if ( el.team() == 0 && ( el.position[0] + 1 == new_pos[0] ) && ( el.position[1] == new_pos[1] ) ) {
				console.log('элемент сдвинулся вниз "'+new_pos+'"');
				return true;
			}
			if ( el.team() == 1 && ( el.position[0] - 1 == new_pos[0] ) && ( el.position[1] == new_pos[1] ) ) {
				console.log ('элемент сдвинулся вверх "'+new_pos+'"');
				return true;
			}
		});
		
		// - перед пешкой припятствие
		ch.right.add('Перед пешкой', function (el, new_pos) {
			if ( (Number(el.position[0]) - Number(el.factor())) == new_pos[0] && el.position[1] == new_pos[1] && ch.fn.findSubstrInSubstr(ch.element.all, 'position', new_pos) > -1) return false; 
		});
		
		// - 2 шага для пешки
		ch.right.add('Шаг 2', function (el, new_pos) {
			if (el.inf.step2 != true) {
				if ( (el.team() == 0 && ( el.position[0] + 2 == new_pos[0] ) && ( el.position[1] == new_pos[1] )) || (el.team() == 1 && ( el.position[0] - 2 == new_pos[0] ) && ( el.position[1] == new_pos[1] )) ) {
					console.log('элемент сдвинулся "'+new_pos+'"');
					el.inf.step2 = true;
					return true;
				}
			}
		});
		
		// - КИЛЛЕРЫ
		// -- пешка
		ch.right.add('К! Пешка', function (el, new_pos) {
			if ( (Number(el.position[0]) - Number(el.factor())) && ( el.position[1] + 1 == new_pos[1]  || el.position[1] - 1 == new_pos[1] )) {
				var n = ch.fn.findSubstrInSubstr(ch.element.all, 'position', new_pos);
				if (n > -1) {
					if (el.kill(n)) return true;
				}
			}
			
		});
		
		// РАЗДАЧА ПРАВ ТИПАМ
		ch.type.addRight('Пешка', ['К! Пешка', 'Перед пешкой', 'Шаг', 'Шаг 2', 'На пути помеха']);
		
		
		// Не проверенный код
		ch.right.add('Ход по вертикали',function (el, new_pos) {
			//for (var i = 1; i < 9; i++) {
				//if ( (el.start[0] == 1 || 8) && (el.position[0] + i == new_pos[0] || el.position[0] - i == new_pos[0]) && el.position[1] == new_pos[1])
					//return true;				
			//}
			//return false;
			if (el.position[1] == new_pos[1] && el.position[0] != new_pos[0]) {
				if (el.position[0] < new_pos[0]) {
					for (var i = el.position[0] + 1; i < new_pos[0]; i++) {
						if (ch.fn.findSubstrInSubstr(ch.element.all, 'position', [new_pos[0], i]) != -1) {
							return false;
						}
					}
					el_new_pos = ch.fn.findSubstrInSubstr(ch.element.all, 'position', new_pos);
					if (el_new_pos != -1) {
						el.kill(el_new_pos);
					}
				}
				else { 
					
				}
			}
			return false;
		});
		
		ch.right.add('Ход по горизонтали', function (el,new_pos) {
			for (var i = 1; i < 9; i++ ) {
				if ((el.start[0] == 1 && el.position[0] == new_pos[0]) && (el.position[1] + [i] == new_pos[1]))
					return true;
				if ((el.start[0] == 8 && el.position[0] == new_pos[0]) && (el.position[1] + [i] == new_pos[1]))
					return true;	
			}
			return false;		
		});
		ch.type.addRight('Ладья', ['Ход по вертикали','Ход по горизонтали'])
		
		ch.right.add ('Ход буквой г', function (el,new_pos) {
			if (el.start[0] == 1 && (el.position[0] - 2 == new_pos[0]) && (el.position[1] - 1 || el.position[1] + 1) == new_pos[1]){
				return true;
			}
			if (el.start[0] == 1 && (el.position[0] - 1 == new_pos[0]) && (el.position[1] - 2 || el.position[1] + 2) == new_pos[1]){
				return true;
			}
			if (el.start[0] == 8 && (el.position[0] + 2 == new_pos[0]) && (el.position[1] + 1 || el.position[1] - 1) == new_pos[1]){
				return true;
			}
			if (el.start[0] == 8 && (el.position[0] + 1 == new_pos[0]) && (el.position[1] + 2 || el.position[1] - 2) == new_pos[1]){
				return true;
			}	
			return false;
		});
		ch.type.addRight('Конь',['Ход буквой г'])
			
			
		
	</script>
</head>
<body>
	<div id="chess1" class="chess"></div>
</body>
</html>
